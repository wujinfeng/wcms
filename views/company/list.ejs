<!DOCTYPE html>
<html lang="utf-8">
<head>
    <%- include ../component/meta.ejs %>
    <title>公司列表</title>
    <style>
        @media screen and (max-width: 1199px) and (min-width: 768px) {
            .form-horizontal .control-label {
                text-align: left;
            }
        }
        /*模糊查询框*/
        .chosen-single {
            padding: 0 0 0 13px!important;
            height: 34px!important;
            border: 1px solid #ccc!important;
            background: none!important;
            background-clip: padding-box;
            box-shadow:  none !important;
            line-height: 34px!important;
        }
        .form-horizontal .control-label{
            text-align: rigth;
        }
        .modal-body{
            padding-bottom: 0;
        }
        .cle{
            clear: both;
        }
    </style>
</head>
<body class="nav-md">
    <div class="container body">
        <!-- main content start-->
        <div class="main_container">
            <!-- left side start-->
            <%- include ../component/left_side.ejs %>
            <!-- left side end-->
            <!-- header section start-->
            <%- include ../component/header_section.ejs %>
            <!-- header section end-->
            <div class="right_col" role="main">
                <!-- page heading start-->
                <div class="page-heading">
                    <ul class="breadcrumb">
                        <li>
                            <a href="#">公司管理</a>
                        </li>
                        <li class="active">
                            <a href="#">公司列表</a>
                        </li>
                    </ul>
                </div>
                <!-- page heading end-->
                <!--body wrapper start-->
                <div class="wrapper">
                    <div class="row">
                        <div class="col-sm-12">
                            <section class="panel">
                                <header class="panel-heading">
                                    <a href="#myModal" data-toggle="modal" class="btn btn-primary" id="add">添加公司</a>
                                </header>
                                <div class="panel-body">
                                    <form action="/pcompany/list" method="get">
                                        <section id="no-more-tables">
                                            <table class="table noneColBorder table-bordered table-hover table-striped clearfix">
                                                <thead class="cf">
                                                <tr>
                                                    <th class="text-center">公司编号</th>
                                                    <th class="text-center">名称</th>
                                                    <th class="text-center">类型</th>
                                                    <th class="text-center">大区</th>
                                                    <th class="text-center">数据库</th>
                                                    <th class="text-center">添加时间</th>
                                                    <th class="text-center">操作</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                <% for (var i = 0; i < rows.length; i++){ %>
                                                <tr>
                                                    <td class="text-center" data-title="公司编号"><%= rows[i].id %></td>
                                                    <td class="text-center" data-title="名称"><%= rows[i].name %></td>
                                                    <td class="text-center" data-title="类型">
                                                        <% if(rows[i].type=='01'){ %>
                                                        总部
                                                        <%}else if(rows[i].type=='02'){%>
                                                        自营
                                                        <%}else if(rows[i].type=='03'){%>
                                                        城市联营
                                                        <%}else if(rows[i].type=='04'){%>
                                                        景区联营
                                                        <%}else if(rows[i].type=='05'){%>
                                                        直营
                                                        <%}%>
                                                    </td>
                                                    <td class="text-center" data-title="大区"><%= rows[i].areaName %></td>
                                                    <td class="text-center" data-title="数据库"><%= rows[i].db %></td>
                                                    <td class="text-center" data-title="添加时间"><%= rows[i].ctime?moment(rows[i].ctime).format('YYYY-MM-DD HH:mm:ss'):'' %></td>
                                                    <td class="text-center" data-title="操作">
                                                        <a href="#myModal" data-toggle="modal"
                                                           class="btn-default btn-sm edit"
                                                           data-id="<%= rows[i].id %>"
                                                           data-db="<%= rows[i].db %>"
                                                           data-type="<%= rows[i].type %>"
                                                           data-area ="<%= rows[i].areaName %>"
                                                           data-name="<%= rows[i].name %>"><i class="fa fa-pencil"></i></a>
                                                        <a class="btn-default btn-sm delete" data-id="<%= rows[i].id %>"
                                                                type="button"><i class="fa fa-trash-o"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                                <% } %>
                                                </tbody>
                                            </table>
                                        </section>
                                        <%- include ../component/pager.ejs %>
                                    </form>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
                <!--body wrapper end-->
            </div>
            <!--footer section start-->
            <%- include ../component/footer.ejs %>
            <!--footer section end-->
        </div>
    </div>
    <!-- main content end-->
<!--modal start -->
<div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="myModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <form class="form-horizontal" role="form">
                <div class="modal-header">
                    <button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
                    <h4 class="modal-title text-center">添加/编辑</h4>
                </div>
                <div class="modal-body">
                    <div class="col-sm-12">
                        <div class="form-group addParenter">
                            <label for="company" class="col-sm-3 control-label star">选择公司：</label>
                            <div class="col-sm-8">
                                <select  class="form-control" data-placeholder="请选择公司" id="company" name="company" required>
                                    <option value=""></option>
                                    <% for(var i=0; i<companyList.length; i++){ %>
                                    <option data-db="<%=companyList[i].bdb%>" data-area="<%=companyList[i].areaName%>" data-areacode="<%=companyList[i].barea%>" value="<%=companyList[i].bid%>"><%=companyList[i].bname%></option>
                                    <%}%>
                                </select>
                            </div>
                        </div>
                        <div class="form-group editParenter">
                            <label for="editCompany" class="col-sm-3 control-label star">选择公司：</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control" id="editCompany" name="editCompany" disabled>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="db" class="col-sm-3 control-label">数据库：</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control" id="db" name="db" value="" readonly required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">大区：</label>
                            <div class="col-sm-8">
                                <input class="form-control" id="area" data-val="" title="" name="area" readonly>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="type" class="col-sm-3 control-label star">类型：</label>
                            <div class="col-sm-8">
                                <select class="form-control" id="type" name="type" required>
                                    <option value="01">总部</option>
                                    <option value="02">自营</option>
                                    <option value="03">城市联营</option>
                                    <option value="04">景区联营</option>
                                    <option value="05">直营</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-9 col-sm-offset-3 text-left">
                            <button type="submit" class="btn btn-success" id="addEdit">&nbsp;&nbsp;&nbsp;保存&nbsp;&nbsp;&nbsp;</button>
                        </div>
                        <div class="form-group"></div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<!--modal end -->
<%- include ../component/bottom.ejs %>
<script>

    //分页
    $("nav .pageTab").click(function () {
        var _form = $(this).closest('form');
        _form.find('input[name=pageNo]').val($(this).attr('data-page'));
        _form.submit();
    });
    //跳转
    $('nav .jumpBtn').click(function(){
        let _form = $(this).closest('form')
        let jumpNo = $(this).siblings('.jumpPageNo').val()
        if(jumpNo){
            $('input[name="pageNo"]').val(jumpNo)
        }else{
            $('input[name="pageNo"]').val(1)
        }
        _form.submit()
    })
    var add_edit = 0,
        id = '';  //add_edit: 1是添加按钮激活， 2是编辑按钮激活的。
    //点击添加按钮
    $('#add').click(function () {
        $('.addParenter').css({'display':'block'});
        $('.editParenter').css({'display':'none'});
        add_edit = 1;
        $('#myModal .modal-title').html('添加');
        $('#company').val('').removeAttr("disabled");  //公司名
        $('#area').val('');  //大区
        $('#db').val('');  //名称
        $("#company").trigger("chosen:updated");  //更新下状态
    });
    //点击编辑按钮
    $('.edit').click(function () {
        $('.addParenter').css({'display':'none'});
        $('.editParenter').css({'display':'block'})
        add_edit = 2;
        $('#myModal .modal-title').html('编辑');
        $('#editCompany').val($(this).attr('data-name')).attr({'companyid':$(this).attr('data-id')}); //公司名
        $('#area').val($(this).attr('data-area')) //大区
        $('#db').val($(this).attr('data-db'));  //数据库
        $('#type').val($(this).attr('data-type')); //类型
        $("#editCompany").trigger("chosen:updated");  //更新下状态
    });

    //保存到后台
    $('#addEdit').click(function (e) {
        e.preventDefault();
        var companyId = $('#company').val();
        var e_companyId = $('#editCompany').attr('companyid');
        var name = $('#company').find('option:selected').text();
        var db = $('#db').val();
        var type = $('#type').val();
        var area = $('#area').attr('data-val');
        if(!companyId && !e_companyId){
            swal(
            {
                title: "请选择公司!",
                text:'',
                type: "",
                confirmButtonText: "确定",
            });
            return false;
        }
        if(!type){
            swal(
            {
                title: "请选择类型!",
                text:'',
                type: "",
                confirmButtonText: "确定",
            });
            return false;
        }
        if(!db){
            swal(
            {
                title: "请先在boss中填写数据库后在添加!",
                text:'',
                type: "",
                confirmButtonText: "确定",
            });
            return false;
        }

        if (add_edit == 1) { //点击添加按钮
            ajax('/pcompany/add', {companyId: companyId, name: name, db: db, type:type,area:area},'你确定提交吗？', '', function (err,result) {
                console.log(err);
                if(err){
                    return  swal(
                    {
                        title: "保存出错！",
                        text:'',
                        type: "",
                        confirmButtonText: "确定",
                    });
                }
                if (result.status == 200) {
                    $('.close').click();
                    swal(
                    {
                        title: "保存成功！",
                        text:'Good, 1秒后自动刷新!',
                        type: "",
                        confirmButtonText: "确定",
                    });
                    setTimeout(function () {
                        window.location.reload();
                    }, 1100);
                } else {
                    swal(
                    {
                        title: "保存出错！",
                        text:result.msg,
                        type: "",
                        confirmButtonText: "确定",
                    });
                }
            });
        } else if (add_edit == 2) {  //点击编辑
            ajax('/pcompany/edit',{companyId: e_companyId, type:type},'你确定提交吗？','', function (err,result) {
                if(err){
                    return  swal(
                    {
                        title: "修改出错！",
                        text:err,
                        type: "",
                        confirmButtonText: "确定",
                    });
                }
                if (result.status == 200) {
                    $('.close').click();
                    swal(
                    {
                        title: "修改成功！",
                        text:'Good, 1秒后自动刷新',
                        type: "",
                        confirmButtonText: "确定",
                    });
                    setTimeout(function () {
                        window.location.reload();
                    }, 1100);
                } else {
                    swal(
                    {
                        title: "修改失败！",
                        text:result.msg,
                        type: "",
                        confirmButtonText: "确定",
                    }
                    )
                }
            });
        }
    })

    //点击删除
    $('.delete').click(function () {
        var companyId = $(this).attr('data-id'),
            url = '/pcompany/delete';
        if (!companyId) {
            swal(
            {
                title: "亲，没有选择公司id！",
                text:'',
                type: "",
                confirmButtonText: "确定",
            });
            return false;
        }
        ajax(url, {companyId: companyId},'你确定删除吗？', '', function (err, result) {
            if(err){
                return  swal(
                {
                    title: "删除出错！",
                    text:err,
                    type: "",
                    confirmButtonText: "确定",
                });
            }
            if (result.status == 200) {
                swal(
                {
                    title: "删除成功！",
                    text:'Good, 1秒后自动刷新',
                    type: "",
                    confirmButtonText: "确定",
                });
                setTimeout(function () {
                    window.location.reload();
                }, 1200);
            } else {
                swal(
                {
                    title: "修改失败！",
                    text:result.msg,
                    type: "",
                    confirmButtonText: "确定",
                })
            }
        });
    });
    //发送ajax
    function ajax(url, data, title,text, cb) {
        swal({
                title: title || '',
                text: text || '',
                type: "",
                showCancelButton: true,
                closeOnConfirm: false,
                showLoaderOnConfirm: true,
                confirmButtonText: "确定",
                cancelButtonText: "取消",
            },
            function () {
                $.ajax({
                    url: url,
                    data: data,
                    type: 'post',
                    async: true,
                    dataType: 'json',
                    success: function (result) {
                        cb(null,result);
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        console.log(textStatus || errorThrown);
                        cb(textStatus || errorThrown)
                    }
                });
            });
    }

    //模糊查询
    $(function () {
        $('#company').chosen({
            width: "100%",
            allow_single_deselect: true //删除选择的项
        }).change(function () {
            $('#db').val($(this).find('option:selected').attr('data-db'));
            $('#area').val($(this).find('option:selected').attr('data-area')).attr({'data-val':$(this).find('option:selected').attr('data-areacode')});
        });
    });

</script>

</body>
</html>
