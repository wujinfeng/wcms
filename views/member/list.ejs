<!DOCTYPE html>
<html lang="utf-8">
<head>
    <%- include ../component/meta.ejs %>
    <title>合作方成员</title>
    <style>
        @media screen and (max-width: 1199px) and (min-width: 768px) {
            .form-horizontal .control-label {
                text-align: left;
            }
        }
        /*模糊查询框*/
        .chosen-single {
            padding: 0 0 0 13px!important;
            height: 34px!important;
            border: 1px solid #ccc!important;
            background: none!important;
            background-clip: padding-box;
            box-shadow:  none !important;
            line-height: 34px!important;
        }
        .form-horizontal .control-label{
            text-align: right;
        }
        .modal-body{
            padding-bottom: 0;
        }
        .cle{
            clear: both;
        }
        .page-heading .breadcrumb .active{
            color: #65CEA7;
        }
    </style>
</head>

<body class="nav-md">
    <div class="container body">
        <!-- main content start-->
        <div class="main_container">
            <!-- left side start-->
            <%- include ../component/left_side.ejs %>
            <!-- left side end-->
            <!-- header section start-->
            <%- include ../component/header_section.ejs %>
            <!-- header section end-->
            <div class="right_col" role="main">
                <!-- page heading start-->
                <div class="page-heading">
                    <ul class="breadcrumb">
                        <li>
                            <a href="#">成员管理</a>
                        </li>
                        <li>
                            <a class="active" href="#">成员列表</a>
                        </li>
                    </ul>
                </div>
                <!-- page heading end-->
                <!--body wrapper start-->
                <div class="wrapper">
                    <div class="row">

                        <div class="col-sm-12">
                            <section class="panel">
                                <header class="panel-heading">
                                    <a href="#myModal" data-toggle="modal" class="btn btn-primary" id="add">添加成员</a>
                                </header>
                                <div class="panel-body">
                                    <form action="/pmember/list" method="get">
                                        <section id="no-more-tables">
                                            <table class="table noneColBorder table-bordered table-hover table-striped clearfix">
                                                <thead class="cf">
                                                <tr>
                                                    <th class="text-center">手机号</th>
                                                    <th class="text-center">名称</th>
                                                    <th class="text-center">合作方名称</th>
                                                    <th class="text-center">创建时间</th>
                                                    <th class="text-center">操作</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                <% for (var i = 0; i < rows.length; i++){ %>
                                                <tr>
                                                    <td class="text-center" data-title="手机号"><%= rows[i].mobile %></td>
                                                    <td class="text-center" data-title="名称"><%= rows[i].name %></td>
                                                    <td class="text-center" data-title="合作方名称"><%= rows[i].partnerName %></td>
                                                    <td class="text-center" data-title="创建时间"><%= rows[i].ctime?moment(rows[i].ctime).format('YYYY-MM-DD HH:mm:ss'):'' %></td>
                                                    <td class="text-center" data-title="操作">
                                                        <a href="#myModal" data-toggle="modal"
                                                           class="btn-default btn-sm edit"
                                                           data-partnerid="<%= rows[i].partnerId %>"
                                                           data-name="<%= rows[i].name %>"
                                                           data-mobile="<%= rows[i].mobile %>"><i class="fa fa-pencil"></i></a>
                                                        <a class="btn-default btn-sm delete" data-mobile="<%= rows[i].mobile %>"
                                                                type="button"><i class="fa fa-trash-o"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                                <% } %>
                                                </tbody>
                                            </table>
                                        </section>
                                        <%- include ../component/pager.ejs %>
                                    </form>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
                <!--body wrapper end-->
            </div>
            <!--footer section start-->
            <%- include ../component/footer.ejs %>
            <!--footer section end-->
        </div>
        <!-- main content end-->
    </div>
<!--modal start -->
<div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="myModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <form class="form-horizontal" role="form">
                <div class="modal-header">
                    <button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
                    <h4 class="modal-title text-center" >添加/编辑</h4>
                </div>
                <div class="modal-body">
                    <div class="col-sm-12">
                        <div class="form-group">
                            <label for="mobile" class="col-sm-3 control-label star">手机号：</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control" id="mobile" name="mobile" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="name" class="col-sm-3 control-label star">名称：</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control" id="name" name="name" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="partner" class="col-sm-3 control-label star">合作方：</label>
                            <div class="col-sm-8">
                                <select  class="form-control" data-placeholder="请选择合作方" id="partner" name="partner" required>
                                    <option value=""></option>
                                    <% for(var i=0; i<partnerList.length; i++){ %>
                                    <option value="<%=partnerList[i].id%>"><%=partnerList[i].name%></option>
                                    <%}%>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-9 col-sm-offset-3 text-left">
                            <button type="submit" class="btn btn-success" id="addEdit">&nbsp;&nbsp;&nbsp;保存&nbsp;&nbsp;&nbsp;</button>
                        </div>
                        <div class="form-group"></div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<!--modal end -->
<%- include ../component/bottom.ejs %>
<script>
    //分页
    $("nav .pageTab").click(function () {
        var _form = $(this).closest('form');
        _form.find('input[name=pageNo]').val($(this).attr('data-page'));
        _form.submit();
    });
    $('nav .jumpBtn').click(function(){
        let _form = $(this).closest('form')
        let jumpNo = $(this).siblings('.jumpPageNo').val()
        if(jumpNo){
            $('input[name="pageNo"]').val(jumpNo)
        }else{
            $('input[name="pageNo"]').val(1)
        }
        _form.submit()
    })
    //去除字符串中所有空格
    function trimAll(str,is_global)
    {
        var result;
        result = str.replace(/(^\s+)|(\s+$)/g,"");
        if(is_global.toLowerCase()=="g")
        {
            result = result.replace(/\s/g,"");
        }
        return result;
    }

    var add_edit = 0,
        id = '';  //add_edit: 1是添加按钮激活， 2是编辑按钮激活的。
    //点击添加按钮
    $('#add').click(function () {
        add_edit = 1;
        $('#myModal .modal-title').html('添加');
        $('#mobile').val('').removeAttr("disabled");  //手机号
        $('#name').val('');  //名称
    });
    //点击编辑按钮
    $('.edit').click(function () {
        add_edit = 2;
        $('#myModal .modal-title').html('编辑');
        $('#mobile').val($(this).attr('data-mobile')).attr('disabled',true); //手机号
        $('#name').val($(this).attr('data-name'));  //名称
        $('#partner').val($(this).attr('data-partnerid')); //合作方id
        $("#partner").trigger("chosen:updated");  //更新下状态
    });

    //保存到后台
    $('#addEdit').click(function (e) {
        e.preventDefault();
        var mobile = trimAll($('#mobile').val(),'g');
        var name = trimAll($('#name').val(),'g');
        var partnerId = $('#partner').val();

        if(!mobile || !(/^((17[0-9])|(13[0-9])|(14[5,7])|(15[0-9])|(18[0-9]))\d{8}$/.test(mobile))){
            swal(
            {
                title: "手机号不正确！",
                text:'',
                type: "",
                confirmButtonText: "确定",
            });
            return false;
        }
        if(!name){
            swal(
            {
                title: "姓名不能为空！",
                text:'',
                type: "",
                confirmButtonText: "确定",
            });
            return false;
        }
        if(!partnerId){
            swal(
            {
                title: "合作方不能为空！",
                text:'',
                type: "",
                confirmButtonText: "确定",
            });
            return false;
        }
        if (add_edit == 1) { //点击添加按钮
            ajax('/pmember/add', {mobile: mobile, name: name, partnerId: partnerId}, '你确定提交吗？','', function (err,result) {
                if(err){
                    return  swal(
                    {
                        title: "保存出错！",
                        text:err,
                        type: "",
                        confirmButtonText: "确定",
                    });
                }
                if (result.status == 200) {
                    $('.close').click();
                    swal(
                    {
                        title: "保存成功！",
                        text:'Good, 1秒后自动刷新',
                        type: "",
                        confirmButtonText: "确定",
                    });
                    setTimeout(function () {
                        window.location.reload();
                    }, 1200);
                } else {
                    swal(
                    {
                        title: "保存出错！",
                        text:result.msg,
                        type: "",
                        confirmButtonText: "确定",
                    });
                }
            });
        } else if (add_edit == 2) {  //点击编辑
            ajax('/pmember/edit',{mobile: mobile, name: name, partnerId: partnerId},'你确定提交吗？','', function (err,result) {
                if(err){
                    return  swal(
                    {
                        title: "修改出错！",
                        text:err,
                        type: "",
                        confirmButtonText: "确定",
                    });
                }
                if (result.status == 200) {
                    $('.close').click();
                    swal(
                    {
                        title: "修改成功！",
                        text:'Good, 1秒后自动刷新',
                        type: "",
                        confirmButtonText: "确定",
                    });
                    setTimeout(function () {
                        window.location.reload();
                    }, 1200);
                } else {
                    swal(
                    {
                        title: "修改失败！",
                        text:result.msg,
                        type: "",
                        confirmButtonText: "确定",
                    })
                }
            });
        }
    })

    //点击删除
    $('.delete').click(function () {
        var mobile = $(this).attr('data-mobile'),
            url = '/pmember/delete';
        if (!mobile) {
            swal(
            {
                title: "亲，没有选择mobile！",
                text:'',
                type: "",
                confirmButtonText: "确定",
            });
            return false;
        }
        ajax(url, {mobile: mobile},'你确定删除吗？', '', function (err, result) {
            if(err){
                return  swal(
                {
                    title: "修改出错！",
                    text:err,
                    type: "",
                    confirmButtonText: "确定",
                });
            }
            if (result.status == 200) {
                swal(
                {
                    title: "修改成功！",
                    text:'Good, 1秒后自动刷新',
                    type: "",
                    confirmButtonText: "确定",
                });
                setTimeout(function () {
                    window.location.reload();
                }, 1200);
            } else {
                swal(
                {
                    title: "修改失败！",
                    text:result.msg,
                    type: "",
                    confirmButtonText: "确定",
                })
            }
        });
    });
    //发送ajax
    function ajax(url, data,title, text, cb) {
        swal({
                title: title ||'',
                text: text || '',
                type: "",
                showCancelButton: true,
                closeOnConfirm: false,
                showLoaderOnConfirm: true,
                confirmButtonText: "确定",
                cancelButtonText: "取消",
            },
            function () {
                $.ajax({
                    url: url,
                    data: data,
                    type: 'post',
                    async: true,
                    dataType: 'json',
                    success: function (result) {
                        cb(null,result);
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        cb(textStatus || errorThrown);
                    }
                });
            });
    }

    //模糊查询
    $(function () {
        $('#partner').chosen({
            width: "100%",
            allow_single_deselect: true //删除选择的项
        });
    });
</script>

</body>
</html>
